"""
Data loader - embeds data for Vercel deployment
Run this script locally to generate embedded data
"""

import json
from pathlib import Path


def convert_nulls(obj):
    """Recursively convert all values for Python compatibility"""
    if obj is None:
        return None
    elif isinstance(obj, dict):
        return {k: convert_nulls(v) for k, v in obj.items()}
    elif isinstance(obj, list):
        return [convert_nulls(item) for item in obj]
    else:
        return obj


def python_repr(obj, indent=0):
    """Convert object to Python code string"""
    spaces = "    " * indent
    
    if obj is None:
        return "None"
    elif isinstance(obj, bool):
        return "True" if obj else "False"
    elif isinstance(obj, str):
        # Escape quotes and special characters
        escaped = obj.replace("\\", "\\\\").replace("'", "\\'").replace("\n", "\\n")
        return f"'{escaped}'"
    elif isinstance(obj, (int, float)):
        return str(obj)
    elif isinstance(obj, list):
        if len(obj) == 0:
            return "[]"
        items = [python_repr(item, indent + 1) for item in obj]
        return "[\n" + ",\n".join(spaces + "    " + item for item in items) + "\n" + spaces + "]"
    elif isinstance(obj, dict):
        if len(obj) == 0:
            return "{}"
        items = [f"{python_repr(k)}: {python_repr(v, indent + 1)}" for k, v in obj.items()]
        return "{\n" + ",\n".join(spaces + "    " + item for item in items) + "\n" + spaces + "}"
    else:
        return repr(obj)


def generate_embedded_data():
    """Read JSON and create Python file with embedded data"""
    
    current_dir = Path(__file__).resolve().parent
    possible_paths = [
        current_dir / "data" / "parsed_results.json",
        current_dir.parent / "data" / "output" / "parsed_results.json",
    ]
    
    data_file = None
    for path in possible_paths:
        if path.exists():
            data_file = path
            break
    
    if not data_file:
        print("‚ùå Data file not found!")
        return False
    
    print(f"üìÇ Loading from: {data_file}")
    
    # Read JSON
    with open(data_file, 'r', encoding='utf-8') as f:
        raw_text = f.read()
    
    # Parse JSON
    data = json.loads(raw_text)
    print(f"‚úÖ Loaded {len(data)} records")
    
    # Convert nulls
    data = convert_nulls(data)
    
    # Generate Python file manually
    output_file = current_dir / "embedded_data.py"
    
    print("üìù Writing Python file...")
    
    with open(output_file, 'w', encoding='utf-8') as f:
        f.write('"""\n')
        f.write('Embedded student data for Vercel deployment\n')
        f.write('Auto-generated by data_loader.py - DO NOT EDIT\n')
        f.write('"""\n\n')
        f.write('# pylint: disable=all\n')
        f.write('# type: ignore\n\n')
        f.write('STUDENT_DATA = [\n')
        
        for i, record in enumerate(data):
            # Build record as Python dict
            f.write('    {\n')
            for key, value in record.items():
                if key == 'subjects':
                    # Handle subjects list
                    f.write(f'        {repr(key)}: [\n')
                    for subj in value:
                        subj_str = ', '.join(f'{repr(k)}: {repr(v) if v is not None else "None"}' for k, v in subj.items())
                        f.write(f'            {{{subj_str}}},\n')
                    f.write('        ],\n')
                else:
                    if value is None:
                        f.write(f'        {repr(key)}: None,\n')
                    elif isinstance(value, str):
                        f.write(f'        {repr(key)}: {repr(value)},\n')
                    else:
                        f.write(f'        {repr(key)}: {repr(value)},\n')
            f.write('    },\n')
            
            # Progress
            if (i + 1) % 500 == 0:
                print(f"  Processed {i + 1}/{len(data)} records...")
        
        f.write(']\n')
    
    file_size = output_file.stat().st_size / 1024
    print(f"‚úÖ Generated: {output_file}")
    print(f"‚úÖ File size: {file_size:.2f} KB")
    
    # Verify syntax
    print("üîç Verifying Python syntax...")
    try:
        with open(output_file, 'r', encoding='utf-8') as f:
            code = f.read()
        compile(code, str(output_file), 'exec')
        print("‚úÖ Syntax OK!")
        
        # Quick test - import it
        exec(code)
        print("‚úÖ Import test passed!")
        return True
        
    except SyntaxError as e:
        print(f"‚ùå Syntax error: {e}")
        return False
    except Exception as e:
        print(f"‚ùå Error: {e}")
        return False


if __name__ == "__main__":
    success = generate_embedded_data()
    if success:
        print("\nüöÄ Ready to deploy!")
        print("Run: vercel --prod")
    else:
        print("\n‚ùå Failed to generate data")